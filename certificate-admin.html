<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            padding-top: 20px;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            margin-bottom: 20px;
        }
        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Certificate Administration</h1>
        
        <div class="alert alert-info">
            <strong>Note:</strong> Make sure the certificate server is running on port 5002.
        </div>
        
        <div id="messageArea" class="alert d-none"></div>
        
        <div class="row">
            <!-- Student ID Management -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Student ID Management</h4>
                    </div>
                    <div class="card-body">
                        <form id="addStudentForm" class="mb-4">
                            <div class="mb-3">
                                <label for="studentId" class="form-label">Student ID</label>
                                <input type="text" class="form-control" id="studentId" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Student ID</button>
                        </form>
                        
                        <h5>Registered Student IDs</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Student ID</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentTable">
                                    <!-- Student IDs will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Certificate Management -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">Certificate Management</h4>
                    </div>
                    <div class="card-body">
                        <form id="addCertificateForm" class="mb-4">
                            <div class="mb-3">
                                <label for="certStudentId" class="form-label">Student ID</label>
                                <input type="text" class="form-control" id="certStudentId" required>
                            </div>
                            <div class="mb-3">
                                <label for="certificateNumber" class="form-label">Certificate Number</label>
                                <input type="text" class="form-control" id="certificateNumber" required>
                            </div>
                            <div class="mb-3">
                                <label for="name" class="form-label">Student Name</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="course" class="form-label">Course</label>
                                <input type="text" class="form-control" id="course" required>
                            </div>
                            <div class="mb-3">
                                <label for="duration" class="form-label">Duration</label>
                                <input type="text" class="form-control" id="duration" required>
                            </div>
                            <div class="mb-3">
                                <label for="college" class="form-label">College</label>
                                <input type="text" class="form-control" id="college" required>
                            </div>
                            <div class="mb-3">
                                <label for="issuedDate" class="form-label">Issued Date</label>
                                <input type="date" class="form-control" id="issuedDate" required>
                            </div>
                            <button type="submit" class="btn btn-success">Add Certificate</button>
                        </form>
                        
                        <h5>Certificates</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Certificate Number</th>
                                        <th>Student ID</th>
                                        <th>Name</th>
                                        <th>Course</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="certificateTable">
                                    <!-- Certificates will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API base URL
        const API_BASE_URL = 'http://localhost:5002';
        
        // DOM Elements
        const messageArea = document.getElementById('messageArea');
        const studentTable = document.getElementById('studentTable');
        const certificateTable = document.getElementById('certificateTable');
        const addStudentForm = document.getElementById('addStudentForm');
        const addCertificateForm = document.getElementById('addCertificateForm');
        
        // Show message function
        function showMessage(message, type) {
            messageArea.textContent = message;
            messageArea.className = `alert alert-${type}`;
            messageArea.classList.remove('d-none');
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                messageArea.classList.add('d-none');
            }, 5000);
        }
        
        // Load student IDs
        async function loadStudentIds() {
            try {
                const response = await fetch(`${API_BASE_URL}/generatedstudentidofregisteredstudentatstudenterastudentid`);
                const data = await response.json();
                
                if (!data || !data.students) {
                    showMessage('No student data found or invalid format', 'warning');
                    return;
                }
                
                studentTable.innerHTML = '';
                
                data.students.forEach(studentId => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${studentId}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteStudent('${studentId}')">Delete</button>
                        </td>
                    `;
                    studentTable.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading student IDs:', error);
                showMessage('Failed to load student IDs', 'danger');
            }
        }
        
        // Load certificates
        async function loadCertificates() {
            try {
                const response = await fetch(`${API_BASE_URL}/certificatesdetailsread.json`);
                const data = await response.json();
                
                if (!data || !data.certificates) {
                    showMessage('No certificate data found or invalid format', 'warning');
                    return;
                }
                
                certificateTable.innerHTML = '';
                
                data.certificates.forEach(cert => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${cert.certificateNumber}</td>
                        <td>${cert.studentId}</td>
                        <td>${cert.name}</td>
                        <td>${cert.course}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteCertificate('${cert.certificateNumber}')">Delete</button>
                        </td>
                    `;
                    certificateTable.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading certificates:', error);
                showMessage('Failed to load certificates', 'danger');
            }
        }
        
        // Add student
        async function addStudent(studentId) {
            try {
                const response = await fetch(`${API_BASE_URL}/add-student`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ studentId })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage(data.message, 'success');
                    loadStudentIds();
                } else {
                    showMessage(data.message || 'Failed to add student ID', 'danger');
                }
            } catch (error) {
                console.error('Error adding student:', error);
                showMessage('Failed to add student ID', 'danger');
            }
        }
        
        // Delete student
        async function deleteStudent(studentId) {
            if (!confirm(`Are you sure you want to delete student ID: ${studentId}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/delete-student`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ studentId })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage(data.message, 'success');
                    loadStudentIds();
                } else {
                    showMessage(data.message || 'Failed to delete student ID', 'danger');
                }
            } catch (error) {
                console.error('Error deleting student:', error);
                showMessage('Failed to delete student ID', 'danger');
            }
        }
        
        // Add certificate
        async function addCertificate(certificate) {
            try {
                // First, get existing certificates
                const response = await fetch(`${API_BASE_URL}/certificatesdetailsread.json`);
                const data = await response.json();
                
                if (!data || !Array.isArray(data.certificates)) {
                    showMessage('Invalid certificate data format', 'danger');
                    return;
                }
                
                // Check if certificate number already exists
                if (data.certificates.some(cert => cert.certificateNumber === certificate.certificateNumber)) {
                    showMessage('Certificate number already exists', 'warning');
                    return;
                }
                
                // Add new certificate to the array
                const certificates = [...data.certificates, certificate];
                
                // Save updated certificates
                const saveResponse = await fetch(`${API_BASE_URL}/add-certificate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ certificates })
                });
                
                const saveData = await saveResponse.json();
                
                if (saveResponse.ok) {
                    showMessage(saveData.message, 'success');
                    loadCertificates();
                } else {
                    showMessage(saveData.message || 'Failed to add certificate', 'danger');
                }
            } catch (error) {
                console.error('Error adding certificate:', error);
                showMessage('Failed to add certificate', 'danger');
            }
        }
        
        // Delete certificate
        async function deleteCertificate(certificateNumber) {
            if (!confirm(`Are you sure you want to delete certificate: ${certificateNumber}?`)) {
                return;
            }
            
            try {
                // First, get existing certificates
                const response = await fetch(`${API_BASE_URL}/certificatesdetailsread.json`);
                const data = await response.json();
                
                if (!data || !Array.isArray(data.certificates)) {
                    showMessage('Invalid certificate data format', 'danger');
                    return;
                }
                
                // Filter out the certificate to delete
                const certificates = data.certificates.filter(cert => cert.certificateNumber !== certificateNumber);
                
                // Save updated certificates
                const deleteResponse = await fetch(`${API_BASE_URL}/delete-certificate`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ certificates, certificateNumber })
                });
                
                const deleteData = await deleteResponse.json();
                
                if (deleteResponse.ok) {
                    showMessage(deleteData.message, 'success');
                    loadCertificates();
                } else {
                    showMessage(deleteData.message || 'Failed to delete certificate', 'danger');
                }
            } catch (error) {
                console.error('Error deleting certificate:', error);
                showMessage('Failed to delete certificate', 'danger');
            }
        }
        
        // Event Listeners
        addStudentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const studentId = document.getElementById('studentId').value.trim();
            if (studentId) {
                addStudent(studentId);
                this.reset();
            }
        });
        
        addCertificateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const certificate = {
                studentId: document.getElementById('certStudentId').value.trim(),
                certificateNumber: document.getElementById('certificateNumber').value.trim(),
                name: document.getElementById('name').value.trim(),
                course: document.getElementById('course').value.trim(),
                duration: document.getElementById('duration').value.trim(),
                college: document.getElementById('college').value.trim(),
                issuedDate: document.getElementById('issuedDate').value,
                createdAt: new Date().toISOString()
            };
            
            addCertificate(certificate);
            this.reset();
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadStudentIds();
            loadCertificates();
        });
    </script>
</body>
</html>